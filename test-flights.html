<!DOCTYPE html>
<html>
<head>
    <title>Test EcoFlight - Flight Retrieval</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">🧪 Test EcoFlight - Flight Retrieval</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-semibold mb-3">Configuration</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">JWT Token</label>
                    <input id="token" type="text" class="w-full p-2 border rounded" placeholder="Paste your 4Fly JWT token here">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Club ID</label>
                    <input id="clubId" type="text" class="w-full p-2 border rounded" placeholder="Your club ID">
                </div>
                <button onclick="testAuth()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Authentication
                </button>
                <button onclick="testFlights()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 ml-2">
                    Test Flight Retrieval
                </button>
            </div>
        </div>
        
        <div id="output" class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-3">Output</h2>
            <pre id="result" class="text-sm bg-gray-100 p-3 rounded overflow-auto max-h-96">Ready for testing...</pre>
        </div>
    </div>
    
    <script>
        function log(message, data = null) {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            let output = `[${timestamp}] ${message}\n`;
            if (data) {
                output += JSON.stringify(data, null, 2) + '\n';
            }
            result.textContent += output + '\n';
            result.scrollTop = result.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('result').textContent = '';
        }
        
        async function testAuth() {
            clearLog();
            const token = document.getElementById('token').value;
            const clubId = document.getElementById('clubId').value;
            
            if (!token) {
                log('❌ Please provide a JWT token');
                return;
            }
            
            try {
                log('🔍 Testing authentication...');
                
                const response = await fetch('http://localhost:3001/auth/4fly-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        club_id: clubId,
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log('✅ Authentication successful!', {
                        user: result.user?.email,
                        club_id: result.club_id
                    });
                } else {
                    log('❌ Authentication failed', result);
                }
                
            } catch (error) {
                log('❌ Error:', error.message);
            }
        }
        
        async function testFlights() {
            clearLog();
            const token = document.getElementById('token').value;
            const clubId = document.getElementById('clubId').value;
            
            if (!token) {
                log('❌ Please provide a JWT token');
                return;
            }
            
            try {
                log('🔍 Testing flight retrieval...');
                log('📍 Using club_id: ' + (clubId || 'not provided'));
                
                const headers = {
                    'Authorization': `Bearer ${token}`,
                };
                
                if (clubId) {
                    headers['x-club-id'] = clubId;
                }
                
                const response = await fetch('http://localhost:3001/api/carbon-analysis', {
                    headers: headers,
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    log('❌ Request failed: ' + response.status, error);
                    return;
                }
                
                const result = await response.json();
                
                log('✅ Request successful!');
                log('📊 Statistics:', {
                    total_flights: result.stats?.total_flights,
                    total_co2: result.stats?.total_co2,
                    flights_returned: result.flights?.length || 0,
                });
                
                if (result.flights && result.flights.length > 0) {
                    log('✈️ Sample flights:', result.flights.slice(0, 3));
                } else {
                    log('⚠️ No flights found for this user/club');
                    log('Debug info:', {
                        user: result.user,
                        club_id: clubId,
                    });
                }
                
            } catch (error) {
                log('❌ Error:', error.message);
            }
        }
        
        // Auto-load from localStorage
        window.onload = () => {
            const savedToken = localStorage.getItem('test_token');
            const savedClubId = localStorage.getItem('test_club_id');
            if (savedToken) document.getElementById('token').value = savedToken;
            if (savedClubId) document.getElementById('clubId').value = savedClubId;
        };
        
        // Save to localStorage on change
        document.getElementById('token').addEventListener('change', (e) => {
            localStorage.setItem('test_token', e.target.value);
        });
        document.getElementById('clubId').addEventListener('change', (e) => {
            localStorage.setItem('test_club_id', e.target.value);
        });
    </script>
</body>
</html>